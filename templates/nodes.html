<!-- 
    Author       : Bernd Waldmann
    Created      : Sun Oct 27 23:01:35 2019

    This Revision: $Id: nodes.html 1682 2024-11-26 16:52:51Z  $    

    Copyright (C) 2019,2021 Bernd Waldmann

    # ErgÃ¤nzungen 2025 Dirk Clemens
    * OTA Firmware Management
    * Datenbank Bereinigung nach Aufbewahrungszeitraum
    * Bootstrapped Web UI
    * Diverse Verbesserungen

    This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0. 
    If a copy of the MPL was not distributed with this file, You can obtain one at http://mozilla.org/MPL/2.0/

    SPDX-License-Identifier: MPL-2.0
-->

{% extends 'base.html' %}
{% from 'macros.html' import pagecontrols with context %}
{% from 'macros.html' import td_or_none with context %}
{% from 'macros.html' import dim_if_none with context %}
{% from 'macros.html' import dim_if_zero with context %}

{% block title %}Nodes{% endblock %}

{% block header %}
  <h1>MySensors <strong>Nodes</strong>
    <span class="ms-3">
      <span id="liveStatus" class="badge bg-secondary">Disconnected</span>
      <button id="toggleLive" class="btn btn-sm btn-outline-primary ms-2" title="Enable live updates">
        <i class="bi bi-play-fill"></i> Live
      </button>
    </span>
  </h1>
{% endblock %}

{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

{{ pagecontrols() }}
<div class="table-responsive">
<table class="table table-hover table-striped">
  <thead class="table-dark">
  <tr>
   <th class="text-center"><a href="{{ url_for(request.endpoint,sort='nid') }}" class="text-white text-decoration-none">Node</a></th>
   <th>Sketch</th>
   <th>Location</th>
   <th><a href="{{ url_for(request.endpoint,sort='date') }}" class="text-white text-decoration-none">Last seen</a></th>
   <th>Version</th>
   <th>Parent</th>
   <th class="text-center">API</th>
   <th>Revision</th>
   <th>ARC</th>
   <th>Days</th>
   <th>Months</th>
   <th>Bat.level</th>
   <th><a href="{{ url_for(request.endpoint,sort='battery') }}" class="text-white text-decoration-none">Bat.chg</a></th>   
  </tr>
  </thead>
  <tbody id="nodeTableBody">
{% for entry in object_list %}
<tr>
  <td class="text-center">
    <div class="dropdown">
      <button class="btn btn-link dropdown-toggle p-0" type="button" data-bs-toggle="dropdown">
        {{ entry.nid }}
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="{{ url_for('sensors',nid=entry.nid) }}"><i class="bi bi-thermometer"></i> Show sensors</a></li>
        <li><a class="dropdown-item" href="{{ url_for('tvalues',nid=entry.nid) }}"><i class="bi bi-activity"></i> Show current values</a></li>
        <li><a class="dropdown-item" href="{{ url_for('values',nid=entry.nid) }}"><i class="bi bi-graph-up"></i> Show all values</a></li>
        <li><a class="dropdown-item" href="{{ url_for('messages',nid=entry.nid) }}"><i class="bi bi-envelope"></i> Show messages</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="{{ url_for('confirm_new_battery', nid = entry.nid) }}"><i class="bi bi-battery-charging"></i> Battery replaced</a></li>
        <li><hr class="dropdown-divider"></li>
        <li>
          <form action="{{ url_for('node_presentation', nid=entry.nid) }}" method="post" class="d-inline">
            <button type="submit" class="dropdown-item"><i class="bi bi-broadcast"></i> Request Presentation</button>
          </form>
        </li>
        <li>
          <form action="{{ url_for('node_discover', nid=entry.nid) }}" method="post" class="d-inline">
            <button type="submit" class="dropdown-item"><i class="bi bi-search"></i> Discover Node</button>
          </form>
        </li>
        <li>
          <form action="{{ url_for('reboot_node', nid=entry.nid) }}" method="post" class="d-inline">
            <button type="submit" class="dropdown-item"><i class="bi bi-arrow-clockwise"></i> Reboot node</button>
          </form>
        </li>
        <li><a class="dropdown-item" href="{{ url_for('confirm_delete_node_requests', nid = entry.nid) }}"><i class="bi bi-trash"></i> Delete requests</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item text-danger" href="{{ url_for('confirm_delete_node', nid = entry.nid) }}"><i class="bi bi-x-circle"></i> Delete node!</a></li>
      </ul>
    </div>
  </td>
  <td>{{ dim_if_none(entry.sk_name) }}</td>
  <td>{{ dim_if_none(entry.location) }}</td>
  <td {% if days_ago(entry.lastseen) > 0 %} class="table-warning" {% endif %} >{{ entry.lastseen.strftime('%d.%m.%Y %H:%M') }}</td>
  <td>{{ dim_if_none(entry.sk_version) }}</td>
  <td class="text-center">{{ dim_if_none(entry.parent) }}</td>
  <td class="text-center">{{ dim_if_none(entry.api_ver) }}</td>
  <td class="text-center">{{ dim_if_zero(entry.sk_revision) }}</td>
  <td class="text-center">{{ dim_if_none(entry.arc) }}</td>
  <td class="text-center">{{ days_ago(entry.lastseen) }}</td>
  <td class="text-center">{{ dim_if_none( months_ago(entry.bat_changed) ) }}</td>
  <td class="text-center">{{ dim_if_none( entry.level ) }}</td>
  <td>{{ entry.bat_changed.strftime('%d.%m.%Y') if entry.bat_changed is not none else "?" }}</td>
</tr>
{% endfor %}
  </tbody>
</table>
</div>
{{ pagecontrols() }}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ========== Server-Sent Events (SSE) for Live Updates ==========
    let eventSource = null;
    let isLiveEnabled = localStorage.getItem('nodeLiveUpdatesEnabled') === 'true';
    
    const liveStatus = document.getElementById('liveStatus');
    const toggleButton = document.getElementById('toggleLive');
    const tableBody = document.getElementById('nodeTableBody');
    
    function updateStatus(status, text) {
        liveStatus.className = `badge bg-${status}`;
        liveStatus.textContent = text;
    }
    
    function connectSSE() {
        if (eventSource) return;
        
        updateStatus('warning', 'Connecting...');
        eventSource = new EventSource('{{ url_for("stream_nodes") }}');
        
        eventSource.onopen = function() {
            updateStatus('success', 'Live');
        };
        
        eventSource.onerror = function() {
            updateStatus('danger', 'Error');
            disconnectSSE();
            // Auto-reconnect after 5 seconds
            setTimeout(() => {
                if (isLiveEnabled) connectSSE();
            }, 5000);
        };
        
        eventSource.onmessage = function(event) {
            try {
                const nodeData = JSON.parse(event.data);
                updateNodeInTable(nodeData);
            } catch (e) {
                console.error('Error parsing SSE data:', e);
            }
        };
    }
    
    function disconnectSSE() {
        if (eventSource) {
            eventSource.close();
            eventSource = null;
            updateStatus('secondary', 'Disconnected');
        }
    }
    
    function updateNodeInTable(nodeData) {
        // Find the row for this node
        const rows = tableBody.querySelectorAll('tr');
        for (let row of rows) {
            const nidCell = row.querySelector('td:first-child');
            if (!nidCell) continue;
            
            const nidButton = nidCell.querySelector('button');
            if (!nidButton) continue;
            
            const nid = parseInt(nidButton.textContent.trim());
            if (nid !== nodeData.nid) continue;
            
            // Found the row - update relevant fields
            const cells = row.querySelectorAll('td');
            let updated = false;
            
            // Update Last seen (column 3, index 3)
            if (nodeData.lastseen) {
                const lastseenCell = cells[3];
                if (lastseenCell) {
                    // Convert format from 'dd.mm.yyyy HH:MM:SS' to 'dd.mm.yyyy HH:MM'
                    const formattedDate = nodeData.lastseen.substring(0, 16);
                    lastseenCell.textContent = formattedDate;
                    lastseenCell.classList.remove('table-warning');
                    lastseenCell.classList.add('animate-fade-in');
                    updated = true;
                }
            }
            
            // Update Parent (column 5, index 5)
            if (nodeData.parent !== undefined) {
                const parentCell = cells[5];
                if (parentCell) {
                    parentCell.textContent = nodeData.parent;
                    parentCell.classList.add('animate-fade-in');
                    updated = true;
                }
            }
            
            // Update ARC (column 8, index 8)
            if (nodeData.arc !== undefined) {
                const arcCell = cells[8];
                if (arcCell) {
                    arcCell.textContent = nodeData.arc;
                    arcCell.classList.add('animate-fade-in');
                    updated = true;
                }
            }
            
            // Update Battery Level (column 11, index 11)
            if (nodeData.bat_level !== undefined) {
                const batCell = cells[11];
                if (batCell) {
                    batCell.textContent = nodeData.bat_level;
                    batCell.classList.add('animate-fade-in');
                    updated = true;
                }
            }
            
            // Highlight entire row briefly
            if (updated) {
                row.classList.add('table-info');
                setTimeout(() => {
                    row.classList.remove('table-info');
                    // Remove fade-in from all cells
                    cells.forEach(cell => cell.classList.remove('animate-fade-in'));
                }, 2000);
            }
            
            break;
        }
    }
    
    toggleButton.addEventListener('click', function() {
        isLiveEnabled = !isLiveEnabled;
        localStorage.setItem('nodeLiveUpdatesEnabled', isLiveEnabled);
        isLiveEnabled ? connectSSE() : disconnectSSE();
    });
    
    if (isLiveEnabled) connectSSE();
    
    window.addEventListener('beforeunload', function() {
        if (eventSource) eventSource.close();
    });
});
</script>
{% endblock %}