<!-- 
    Author       : Bernd Waldmann
    Created      : Sun Oct 27 23:01:35 2019

    This Revision: $Id: sensors.html 1682 2024-11-26 16:52:51Z  $    

    Copyright (C) 2019,2021 Bernd Waldmann

    # ErgÃ¤nzungen 2025 Dirk Clemens
    * OTA Firmware Management
    * Datenbank Bereinigung nach Aufbewahrungszeitraum
    * Bootstrapped Web UI
    * Diverse Verbesserungen


    This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0. 
    If a copy of the MPL was not distributed with this file, You can obtain one at http://mozilla.org/MPL/2.0/

    SPDX-License-Identifier: MPL-2.0
-->

{% extends 'base.html' %}
{% from 'macros.html' import pagecontrols with context %}
{% from 'macros.html' import td_or_none with context %}
{% from 'macros.html' import dim_if_none with context %}

{% block title %}Sensors{% endblock %}

{% block header %}
  <h1>MySensors <strong>Sensors</strong>{% if nid %} for Node {{ nid }} {% endif %}
    <span class="ms-3">
      <span id="liveStatus" class="badge bg-secondary">Disconnected</span>
      <button id="toggleLive" class="btn btn-sm btn-outline-primary ms-2" title="Enable live updates">
        <i class="bi bi-play-fill"></i> Live
      </button>
    </span>
  </h1>
{% endblock %}

{% block content %}
{{ pagecontrols() }}
<div class="table-responsive">
<table class="table table-hover table-striped">
  <thead class="table-dark">
  <tr>
   <th class="text-center"><a href="{{ url_for(request.endpoint,sort='usid') }}" class="text-white text-decoration-none">Node</a></th>
   <th>Location</th>
   <th class="text-center"><a href="{{ url_for(request.endpoint,sort='cid') }}" class="text-white text-decoration-none">Sensor</a></th>
   <th>Sensor Type</th>
   <th>Description</th>
   <th>Value Type</th>
   <th><a href="{{ url_for(request.endpoint,sort='date') }}" class="text-white text-decoration-none">Last seen</a></th>
   <th class="text-center">days</th>
  </tr>
  </thead>
  <tbody id="sensorTableBody">
{% for entry in object_list %}
<tr>  
  <td class="text-center">
    <div class="dropdown">
      <button class="btn btn-link dropdown-toggle p-0" type="button" data-bs-toggle="dropdown"
              data-bs-toggle="tooltip" data-bs-placement="top" 
              title="{{ entry.nid.sk_name or 'Unknown' }}{% if entry.nid.location %} - {{ entry.nid.location }}{% endif %}">
        {{ entry.nid.nid }}
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="{{ url_for('values', nid=entry.nid.nid) }}">Show values for this node</a></li>
        <li><a class="dropdown-item" href="{{ url_for('messages', nid=entry.nid.nid) }}">Show messages for this node</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="{{ url_for('sensors',nid = entry.nid.nid) }}">Show only this node</a></li>
        <li><a class="dropdown-item" href="{{ url_for('sensors',nid = '-' ~ entry.nid.nid) }}">Show all but this node</a></li>
        <li><a class="dropdown-item" href="{{ url_for('sensors') }}">Show all nodes</a></li>
      </ul>
    </div>
  </td>
  <td>{{ dim_if_none(entry.nid.location) }}</td>
  <td class="text-center">
    <div class="dropdown">
      <button class="btn btn-link dropdown-toggle p-0" type="button" data-bs-toggle="dropdown">{{ entry.cid }}</button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="{{ url_for('tvalues', usid=entry.usid, nid=entry.nid, cid=entry.cid) }}">Show current values</a></li>
        <li><a class="dropdown-item" href="{{ url_for('values', usid=entry.usid, nid=entry.nid, cid=entry.cid) }}">Show all values</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item text-danger" href="{{ url_for('confirm_delete_sensor', usid=entry.usid) }}">Delete sensor instance</a></li>
      </ul>
    </div>
  </td>
  <td><code>{{ dim_if_none( sensor_string(entry.typ) ) }}</code></td>
  <td>{{ dim_if_none(entry.name) }}</td>
  <td><small>{{ values_string(entry.values) }}</small></td>
  <td {% if days_ago(entry.lastseen) > 0 %}class="table-warning"{% endif %}>{{ entry.lastseen.strftime('%d.%m.%Y %H:%M') }}</td>
  <td class="text-center">{{ days_ago(entry.lastseen) }}</td>
</tr>
{% endfor %}
  </tbody>
</table>
</div>
{{ pagecontrols() }}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // ========== Server-Sent Events (SSE) for Live Updates ==========
    let eventSource = null;
    let isLiveEnabled = localStorage.getItem('sensorLiveUpdatesEnabled') === 'true';
    const maxDisplayedSensors = 500;
    
    const liveStatus = document.getElementById('liveStatus');
    const toggleButton = document.getElementById('toggleLive');
    const tableBody = document.getElementById('sensorTableBody');
    
    function updateStatus(status, text) {
        liveStatus.className = `badge bg-${status}`;
        liveStatus.textContent = text;
    }
    
    function connectSSE() {
        if (eventSource) {
            eventSource.close();
        }
        
        updateStatus('warning', 'Connecting...');
        eventSource = new EventSource('{{ url_for("stream_sensors") }}');
        
        eventSource.onopen = function() {
            updateStatus('success', 'Live');
            toggleButton.innerHTML = '<i class="bi bi-pause-fill"></i> Live';
            toggleButton.classList.remove('btn-outline-primary');
            toggleButton.classList.add('btn-primary');
        };
        
        eventSource.onmessage = function(event) {
            try {
                const sensor = JSON.parse(event.data);
                updateSensorInTable(sensor);
            } catch (e) {
                console.error('Error parsing SSE message:', e);
            }
        };
        
        eventSource.onerror = function() {
            updateStatus('danger', 'Error');
            eventSource.close();
            
            if (isLiveEnabled) {
                setTimeout(() => {
                    if (isLiveEnabled) {
                        connectSSE();
                    }
                }, 5000);
            }
        };
    }
    
    function disconnectSSE() {
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }
        updateStatus('secondary', 'Disconnected');
        toggleButton.innerHTML = '<i class="bi bi-play-fill"></i> Live';
        toggleButton.classList.remove('btn-primary');
        toggleButton.classList.add('btn-outline-primary');
    }
    
    function updateSensorInTable(sensor) {
        // Find existing row with matching usid or nid/cid
        const rows = tableBody.querySelectorAll('tr');
        let existingRow = null;
        
        for (let row of rows) {
            // Try to match by nid and cid from dropdowns
            const nidBtn = row.querySelector('td:nth-child(1) button');
            const cidBtn = row.querySelector('td:nth-child(3) button');
            if (nidBtn && cidBtn) {
                const rowNid = parseInt(nidBtn.textContent.trim());
                const rowCid = parseInt(cidBtn.textContent.trim());
                if (rowNid === sensor.nid && rowCid === sensor.cid) {
                    existingRow = row;
                    break;
                }
            }
        }
        
        if (existingRow) {
            // Update lastseen column (7th column)
            const lastseenCell = existingRow.querySelector('td:nth-child(7)');
            if (lastseenCell) {
                lastseenCell.textContent = sensor.lastseen;
                lastseenCell.classList.add('animate-fade-in');
                setTimeout(() => {
                    lastseenCell.classList.remove('animate-fade-in');
                }, 2000);
            }
            
            // Update days column (8th column) - set to 0 for fresh update
            const daysCell = existingRow.querySelector('td:nth-child(8)');
            if (daysCell) {
                daysCell.textContent = '0';
            }
        }
    }
    
    // Toggle button handler
    toggleButton.addEventListener('click', function() {
        isLiveEnabled = !isLiveEnabled;
        localStorage.setItem('sensorLiveUpdatesEnabled', isLiveEnabled);
        
        if (isLiveEnabled) {
            connectSSE();
        } else {
            disconnectSSE();
        }
    });
    
    // Auto-start if enabled
    if (isLiveEnabled) {
        connectSSE();
    }
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (eventSource) {
            eventSource.close();
        }
    });
});
</script>
{% endblock %}